<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบฟอร์มลงทะเบียนสมาชิก IDEA (FINAL PRODUCTION)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base Styles */
        body { font-family: 'Kanit', sans-serif; background-color: #f4f6f9; }
        .card { border-top: 3px solid #1e88e5; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .card-header { 
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 0.75rem 1.25rem;
            cursor: pointer; 
            transition: background-color 0.2s;
        }
        .card-header:hover { background-color: #e9ecef; }
        .form-container { max-width: 800px; }
        .logo-size { width: 70px; height: auto; }
        .main-title-blue { color: #00008B; } 
        .text-innovation-color { color: #d84340; }
        .text-digital-color { color: #00008B; }

        .btn-submit {
            background-color: #1e88e5; 
            border-color: #1e88e5;
            transition: background-color 0.2s;
        }
        .btn-submit:hover {
            background-color: #1a76c7;
            border-color: #1a76c7;
        }
        .btn-link-style {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        /* Debug Toggle Button Style */
        .btn-debug-toggle {
            font-size: 0.75rem;
            padding: 0.5rem 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="form-container mx-auto">

            <div class="text-center mb-4">
                <img src="https://idea.ass.in.th/assets/idea-logo.png" alt="โลโก้สมาคม IDEA" class="mx-auto mb-2 object-contain logo-size">
                <h3 class="h4 fw-bold main-title-blue">สมัครสมาชิกสมาคม IDEA</h3> 
                <p class="text-muted small">
                    <span class="text-innovation-color">I</span>nnovation and 
                    <span class="text-digital-color">D</span>igital 
                    <span class="text-innovation-color">E</span>conomy 
                    <span class="text-digital-color">D</span>evelopment 
                    <span class="text-innovation-color">A</span>ssociation
                </p>
                <p id="debug-status" class="mt-3 small text-muted"></p>
            </div>

            <form 
                id="__vtigerWebForm" 
                name="สมัครสมาชิกสมาคม IDEA" 
                method="post" 
                accept-charset="utf-8" 
                enctype="multipart/form-data" 
            >
                
                <input type="hidden" name="__vtrftk" value="sid:18d869d1c7fb7a2e3aaebd6d2f8fbceed88ad942,1761550630">
                <input type="hidden" name="publicid" value="18a2364ad93c265af185721be682bfcb">
                <input type="hidden" name="urlencodeenable" value="1">
                <input type="hidden" name="name" value="สมัครสมาชิกสมาคม IDEA">
                <input type="hidden" name="cf_945" value="">
                
                <input type="hidden" name="redirecturl" value="https://idea.ass.in.th/"> 
                <input type="hidden" id="formActionUrl" value="https://crm.idea.or.th/modules/Webforms/capture.php"> 
                <input type="hidden" name="member_id" value=""> 
                <input type="hidden" name="firstname" value=""> 
                <input type="hidden" name="lastname_final" value="">
                <div class="card shadow-lg">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        <h5 class="card-title mb-0 section-header">
                            <i class="fas fa-user me-2"></i> ข้อมูลทั่วไปของสมาชิก
                        </h5>
                    </div>
                    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne">
                        <div class="card-body">
                            <div class="row g-3">
                                
                                <div class="col-md-6">
                                    <label for="lastname" class="form-label small fw-bold">ชื่อ-นามสกุล <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="text" id="lastname" name="lastname" data-label="Last Name*" required class="form-control" placeholder="กรอกชื่อ-นามสกุล">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="cf_939" class="form-label small fw-bold">ชื่อเล่น</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-child"></i></span>
                                        <input type="text" id="cf_939" name="cf_939" data-label="Nickname" class="form-control" placeholder="ชื่อเล่น">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="phone" class="form-label small fw-bold">เบอร์มือถือ <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone-alt"></i></span>
                                        <input type="tel" id="phone" name="phone" data-label="Primary Phone" required class="form-control" placeholder="0XX-XXX-XXXX">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="email" class="form-label small fw-bold">Email</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                        <input type="email" id="email" name="email" data-label="Primary Email" class="form-control" placeholder="example@domain.com">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="cf_895" class="form-label small fw-bold">Line ID</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fab fa-line"></i></span>
                                        <input type="text" id="cf_895" name="line_id" data-label="Line ID" class="form-control" placeholder="Line ID">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="designation" class="form-label small fw-bold">ตำแหน่งในสมาคม</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                                        <input type="text" id="designation" name="designation" data-label="Designation" class="form-control" placeholder="ตำแหน่ง">
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <label for="cf_935" class="form-label small fw-bold">ที่อยู่</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                        <textarea id="cf_935" name="expertise" data-label="Expertise" class="form-control" rows="2" placeholder="ที่อยู่ปัจจุบัน"></textarea>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="cf_899" class="form-label small fw-bold">ประเภทสมาชิก <span class="text-danger">*</span></label>
                                    <select id="cf_899" name="member_type" data-label="label:Member+Type" required class="form-select">
                                        <option value="สามัญ">สมาชิก สามัญ</option>
                                        <option value="วิสามัญ">สมาชิก วิสามัญ</option>
                                        <option value="ที่ปรึกษา">ที่ปรึกษา</option>
                                        <option value="สมทบ">สมาชิก สมทบ</option>
                                        <option value="ทั่วไป">สมาชิก ทั่วไป</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-lg">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                        <h5 class="card-title mb-0 section-header">
                            <i class="fas fa-briefcase me-2"></i> ข้อมูลธุรกิจของสมาชิก
                        </h5>
                    </div>
                    <div id="collapseTwo" class="collapse show" aria-labelledby="headingTwo">
                        <div class="card-body">
                            <div class="row g-3">

                                <div class="col-md-6">
                                    <label for="cf_903" class="form-label small fw-bold">ประเภทธุรกิจ</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                        <input type="text" id="cf_903" name="business_type" data-label="Business Type" class="form-control" placeholder="ประเภทธุรกิจ">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="company" class="form-label small fw-bold">บริษัท / แบรนด์</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                                        <input type="text" id="company" name="company" data-label="Company" class="form-control" placeholder="ชื่อบริษัท/แบรนด์">
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <label for="cf_911_expertise" class="form-label small fw-bold">ความเชี่ยวชาญ</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-brain"></i></span>
                                        <textarea id="cf_911_expertise" name="certificate" data-label="Certificate" class="form-control" rows="2" placeholder="ความเชี่ยวชาญ"></textarea>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="cf_907_products" class="form-label small fw-bold">รายการสินค้า</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-box-open"></i></span>
                                        <textarea id="cf_907_products" name="cf_907" data-label="Area Size" class="form-control" rows="2" placeholder="รายการสินค้า/บริการ"></textarea>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="website" class="form-label small fw-bold">เว็บไซต์ / Facebook</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-globe"></i></span>
                                        <input type="url" id="website" name="website" data-label="Website" class="form-control" placeholder="URL">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="cf_913" class="form-label small fw-bold">จังหวัดที่ดำเนินธุรกิจ</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map"></i></span>
                                        <input type="text" id="cf_913" name="production_capacity" data-label="Production Capacity" class="form-control" placeholder="จังหวัด">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="cf_897" class="form-label small fw-bold">ใบรับรอง/Certificate</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-certificate"></i></span>
                                        <input type="text" id="cf_897" name="tax_id" data-label="Tax ID" class="form-control" placeholder="ใบรับรอง">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="cf_907_contact_channels" class="form-label small fw-bold">ช่องทางการติดต่อ</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-share-alt"></i></span>
                                        <input type="text" id="cf_907_contact_channels" name="cf_907_contact_channels" data-label="Contact Channels" class="form-control" placeholder="ช่องทางติดต่อ">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="cf_901_referrer" class="form-label small fw-bold">รู้จักผ่านสมาชิกท่านใด (Optional)</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-hands-helping"></i></span>
                                        <input type="text" id="cf_901_referrer" name="association_position" data-label="Referrer" class="form-control" placeholder="ชื่อผู้แนะนำ">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="cf_909" class="form-label small fw-bold">ช่วยเหลือธุรกิจ</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-lightbulb"></i></span>
                                        <input type="text" id="cf_909" name="business_goal" data-label="Business Goal" class="form-control" placeholder="การช่วยเหลือ">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-block text-center mt-5">
                    <button type="button" id="submitBtn" class="btn btn-submit text-white btn-lg px-4">
                        <i class="fas fa-save me-2"></i> บันทึกข้อมูล
                    </button>
                    <button type="button" id="debugToggleBtn" class="btn btn-debug-toggle btn-outline-danger">
                        <i class="fas fa-bug me-1"></i> สลับโหมด DEBUG
                    </button>
                    <a href="https://idea.ass.in.th/" class="btn btn-outline-secondary btn-lg btn-link-style">
                        <i class="fas fa-arrow-left me-2"></i> กลับสู่ Dashboard
                    </a>
                </div>
            </form>
            </div>
    </div>

    <script type="text/javascript">
        window.onload = function() { 
            // FIX 1: การเคลียร์ค่า Pre-filled Data (เพื่อให้ฟอร์มว่างเปล่า)
            document.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.value === '0') {
                    input.value = '';
                }
            });

            // ===============================================================
            // DEBUG MODE & TOGGLE LOGIC
            // ===============================================================
            const DEBUG_KEY = 'v_form_debug_mode';
            const debugToggleBtn = document.getElementById('debugToggleBtn');
            const debugStatusText = document.getElementById('debug-status');
            
            function isDebugMode() {
                return localStorage.getItem(DEBUG_KEY) === 'true';
            }

            function updateDebugStatus() {
                const mode = isDebugMode();
                debugToggleBtn.classList.toggle('btn-outline-danger', !mode);
                debugToggleBtn.classList.toggle('btn-danger', mode);
                debugToggleBtn.textContent = mode ? 'ปิด DEBUG' : 'เปิด DEBUG';
                debugStatusText.textContent = mode ? '🚩 **DEBUG MODE IS ON**' : '';

                // ปรับปุ่ม Submit
                const submitButton = document.getElementById("submitBtn");
                submitButton.textContent = mode ? 'บันทึกข้อมูล (DEBUG ON)' : 'บันทึกข้อมูล';
                submitButton.classList.toggle('btn-submit-debug', mode);
            }

            // Load initial status
            if (localStorage.getItem(DEBUG_KEY) === null) {
                localStorage.setItem(DEBUG_KEY, 'false'); // Default to OFF
            }
            updateDebugStatus();

            debugToggleBtn.addEventListener('click', () => {
                const newStatus = !isDebugMode();
                localStorage.setItem(DEBUG_KEY, newStatus);
                updateDebugStatus();
                if (newStatus) {
                    alert("⚠️ เปิด DEBUG MODE แล้ว: เมื่อกดบันทึกข้อมูล ข้อมูลจะถูกแสดงใน Console (F12) และไม่ถูกส่งจริง");
                } else {
                    alert("✅ ปิด DEBUG MODE แล้ว: เมื่อกดบันทึกข้อมูล ระบบจะส่งข้อมูลไปยัง vTiger ทันที");
                }
            });
            // ===============================================================

            // -----------------------------------------------------------------
            // 🛑 DEBUGGING FUNCTION: แสดงข้อมูลที่จะส่ง (ใช้ Console.table)
            // -----------------------------------------------------------------
            function debugSubmit(formData) {
                let debugData = [];
                const formActionUrl = "https://crm.idea.or.th/modules/Webforms/capture.php"; // ใช้ URL จริงสำหรับแสดงผล

                for (const pair of formData.entries()) {
                    const [key, value] = pair;
                    
                    debugData.push({
                        Field: key,
                        Value: value,
                        Status: (value !== '' && value !== '0') ? 'OK' : (value === '' ? 'EMPTY' : 'ZERO')
                    });
                }

                console.clear();
                console.log("🚩 🛑 DEBUGGING POST DATA (FINAL CLEANED DATA):");
                console.table(debugData);
                alert("✅ DEBUG SUCCESS! ข้อมูลพร้อมส่ง กรุณาตรวจสอบ Console (F12) เพื่อดูตารางข้อมูลสุดท้าย");
            }
            // -----------------------------------------------------------------


            // -----------------------------------------------------------------
            // 🛑 FINAL SUBMIT LOGIC (ถูกเรียกเมื่อคลิกปุ่ม)
            // -----------------------------------------------------------------
            const form = document.getElementById("__vtigerWebForm");
            const submitButton = document.getElementById("submitBtn");
            const formActionUrl = "https://crm.idea.or.th/modules/Webforms/capture.php";
            const redirectUrl = document.querySelector('input[name="redirecturl"]').value;

            submitButton.addEventListener('click', function(e) {
                
                // 1. รัน Validation Script ของ vTiger ก่อน
                if (window.vtigerValidate && !window.vtigerValidate()) {
                    return;
                }

                const formData = new FormData(form);
                
                // 2. การสร้าง finalFormData เพื่อ Bypass '0' และแยก Full Name
                const finalFormData = new FormData();
                
                // **** FIX 2: การแยกชื่อ-นามสกุล และจัดค่าลงใน finalFormData ****
                const fullNameInput = document.querySelector('input[name="lastname"]');
                const fullName = fullNameInput.value.trim();
                const parts = fullName.split(/\s+/);
                const firstName = parts.length > 1 ? parts.shift() : '';
                const lastName = parts.join(' ');
                
                // Add the split values
                finalFormData.append('firstname', firstName); 
                finalFormData.append('lastname', lastName);
                
                // Logic: คัดลอก Field ที่เหลือ (ที่ถูก Clean แล้ว) เพื่อ Bypass '0'
                for (const pair of formData.entries()) {
                    const [key, value] = pair;
                    
                    // ข้าม input lastname (เพราะเราใช้ fullname_input) และค่าที่ mapping ไปแล้ว
                    if (key === 'lastname' || key === 'firstname') {
                        continue;
                    }
                    
                    // Logic: คัดลอกเฉพาะ Field ที่มีค่าไม่ว่าง ("") หรือไม่ใช่ "0" เข้าไปใน finalFormData
                    if (value !== '' && value !== '0') {
                        finalFormData.append(key, value);
                    } else if (key === 'redirecturl' || key === 'publicid' || key === '__vtrftk' || key === 'name' || key === 'urlencodeenable' || key === 'member_id') {
                        // ต้องเพิ่ม Hidden Fields ที่จำเป็นเสมอ แม้จะเป็นค่าว่าง
                        finalFormData.append(key, value);
                    }
                }
                
                // 3. รัน DEBUG หรือ LIVE SUBMIT
                if (isDebugMode()) {
                    debugSubmit(finalFormData); 
                    return;
                }
                
                // --- LIVE SUBMIT (Production Mode) ---
                if (confirm("ยืนยันการส่งข้อมูลจริงหรือไม่?")) {
                     fetch(formActionUrl, {
                        method: 'POST',
                        body: finalFormData, // ใช้ finalFormData ที่ถูก Clean แล้ว
                    }).then(response => response.text())
                      .then(text => {
                          if (text.includes('"success":true')) {
                              window.location.href = redirectUrl; // REDIRECT สำเร็จ
                          } else {
                              alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาตรวจสอบข้อมูลที่กรอกอีกครั้ง');
                              console.error("vTiger Submit Error:", text);
                          }
                      })
                      .catch(error => {
                          console.error('Fetch Error:', error);
                          alert('เกิดข้อผิดพลาดในการส่งข้อมูล: กรุณาตรวจสอบ Console (F12) หากยังพบปัญหา');
                      });
                }
            });


            // Original vTiger Validation Script (ถูกดัดแปลงเป็น function ที่เรียกใช้ได้)
            window.vtigerValidate = function() {
                var inputs = form.elements;  var required = [], att, val; for (var i = 0; i < inputs.length; i++) { att = inputs[i].getAttribute("required"); val = inputs[i].value; type = inputs[i].type; if(type == "email") {if(val != "") {var elemLabel = inputs[i].getAttribute("label");var emailFilter = /^[_/a-zA-Z0-9]+([!"#$%&()*+,./:;<=>?\^_`{|}~-]?[a-zA-Z0-9/_/-])*@[a-zA-Z0-9]+([\_\-\.]?[a-zA-Z0-9]+)*\.([\-\_]?[a-zA-Z0-9])+(\.?[a-zA-Z0-9]+)?$/;var illegalChars= /[\(\)\<\>\,\;\:\"\[\]]/ ;if (!emailFilter.test(val)) {alert("For "+ elemLabel +" field please enter valid email address"); return false;} else if (val.match(illegalChars)) {alert(elemLabel +" field contains illegal characters");return false;}}}if (att != null) { if (val.replace(/^\s+|\s+$/g, "") == "") { required.push(inputs[i].getAttribute("label")); } } } if (required.length > 0) { alert("The following fields are required: " + required.join()); return false; } var numberTypeInputs = document.querySelectorAll("input[type=number]");for (var i = 0; i < numberTypeInputs.length; i++) { val = numberTypeInputs[i].value;var elemLabel = numberTypeInputs[i].getAttribute("label");var elemDataType = numberTypeInputs[i].getAttribute("datatype");if(val != "") {if(elemDataType == "double") {var numRegex = /^[+-]?\d+(\.\d+)?$/;}else{var numRegex = /^[+-]?\d+$/;}if (!numRegex.test(val)) {alert("For "+ elemLabel +" field please enter valid number"); return false;}}}var dateTypeInputs = document.querySelectorAll("input[type=date]");for (var i = 0; i < dateTypeInputs.length; i++) {dateVal = dateTypeInputs[i].value;var elemLabel = dateTypeInputs[i].getAttribute("label");if(dateVal != "") {var dateRegex = /^[1-9][0-9]{3}-(0[1-9]|1[0-2]|[1-9]{1})-(0[1-9]|[1-2][0-9]|3[0-1]|[1-9]{1})$/;if(!dateRegex.test(dateVal)) {alert("For "+ elemLabel +" field please enter valid date in required format"); return false;}}}var inputElems = document.querySelectorAll("input[type='file']");var totalFileSize = 0;for(var i = 0; i < inputElems.length; i++) {if(inputElems[i].type.toLowerCase() === "file") {var file = inputElems[i].files[0];if(typeof file !== "undefined") {var totalFileSize = totalFileSize + file.size;}}}if(totalFileSize > 52428800) {alert("Maximum allowed file size including all files is 50MB.");return false;}
                
                return true;
            };


            // บังคับผูก Validation Script เข้ากับ Form 
            form.onsubmit = window.vtigerValidate;

        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>